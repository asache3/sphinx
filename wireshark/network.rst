=========
Network
=========

ネットワークの種類
====================

LAN
-----

* 各会社や家庭など同じ建物の中(Local)で構成するネットワークのこと。
* 通信料を払わなくていい

WAN
-----

* 電気通信事業者が提供する通信回線を利用して、離れたところにあるLAN同士を接続するネットワーク。
* 通信料金がかかる


OSI参照モデル
===============

* ネットワーク通信の処理を7つの階層に分ける

.. csv-table::
  :header-rows: 1

  層,機能,プロトコル
  アプリケーション層(第7層),ユーザーがネットワーク上のリソースにアクセスするための手段。エンドユーザーから見える唯一の層。,HTTP、SMTP、FTP、Telnet
  プレゼンテーション層(第6層),受信したデータをアプリケーション層が読み取ることのできる形式に変換する。データのセキュリティ維持のための暗号化や復号化も行う。,ASCII、MPEG、JPEG、MIDI
  セッション層(第5層),2台のコンピュータ間の「対話」すなわちセッションを制御し、通信機器間のコネクションの確立、管理、切断を行う。,NetBIOS、SAP、SDP
  トランスポート層(第4層),フロー制御、データの分割と再構築、誤り制御といった機能により、トランスポート層は2点間のデータのやり取りをエラーなしで行える。ファイアウォールやプロキシサーバには、この層で動作するものもある。,TCP、UDP
  ネットワーク層(第3層),物理的なネットワークを越えて転送されるデータのルーティングを提供する。ネットワーク上のコンピュータの論理アドレス(IPアドレスなど)のアドレス指定(アドレッシング)を行う。ルータはこの層で動作する。,IP
  データリンク層(第2層),物理的なネットワーク上でデータを転送する手段を提供する。物理的な通信機器を特定するためのアドレス指定スキーム(MACアドレスなど)を提供する。ブリッジとスイッチはデータリンク層で動作する。,Ethernet
  物理層(第1層),ネットワーク上でデータを転送するための物理的な媒体。コネクションを確立および切断し、通信リソースを共有する手段を提供し、信号をデジタルからアナログ、またはその逆に変換する。電圧、ハブ、ネットワークアダプタ、リピータ、ケーブル仕様といった、使用されるハードウェアの物理的、電気的な特性を定義する。,


データのカプセル化
====================

* OSI参照モデルの異なる層のプロトコルが通信するには、データをカプセル化する必要がある
* カプセル化処理とは、PDU(Protocol Data Unit：プロトコルデータユニット)を生成すること
* PDUには、送信されるデータと追加されたヘッダおよびフッタ情報のすべてが含まれる


シーケンス制御
================

* 宅急便の個口の考え方


ネットワークハードウェア
==========================

ハブ
------

* 不要なネットワークトラフィックを大量に生み出し、(データの送受信を同時に行うことができない)半二重モードでしか動作しない
* OSI参照モデルの物理層で動作する、データの中継を行う通信機器以上のものではない
* あるポートに送信されたパケットをすべてのポートに伝送(中継)する

スイッチ
----------

* データの送受信が同時にできる全二重モードの通信機器
* ハブのようにすべてのポートにデータを送信するのではなく、宛先となるコンピュータのみにデータを送信する
* 特定の機器と直接通信できるようにするため、スイッチは通信機器をMACアドレスで識別する

  * スイッチはOSI参照モデルのデータリンク層で動作する

* 接続されているすべての通信機器の第2層のアドレスをCAMテーブルに記録している


ルータ
--------

* OSI参照モデルの第3層で動作し、複数のネットワーク間でパケットを転送する
* ネットワークAのコンピュータがネットワークBのコンピュータと通信する場合、送信されるデータは必ずルータを経由しなければならない


トラフィック
==============

ブロードキャスト
------------------

* ブロードキャストパケットは、ネットワークセグメント上のすべてのポートに送信される
* 第2層の形式の場合、MACアドレスFF:FF:FF:FF:FF:FF:FFがブロードキャスト専用アドレスとして予約されている
* 第3層にも専用のブロードキャストアドレスがあり、IPネットワークの場合、アドレス帯の中でもっとも高位のIPアドレスがブロードキャストアドレスとして用いられる

マルチキャスト
----------------

* 1つの送信元から複数の宛先に同時にパケットを送信する手段
* 一般的な実装は、パケットを受信するコンピュータをマルチキャストグループとしてグループ化し、そのグループにアドレスを割り当てる方式

ユニキャスト
--------------

* ユニキャストパケットはコンピュータからコンピュータへ直接送信される


プロミスキャスモード
======================

* ネットワーク上のパケットを監視するには、プロミスキャスモードをサポートしているNICが必要
* ネットワークを流れるすべてのパケットを参照できるようにするのが、プロミスキャスモード


スイッチで構成されたネットワークでのキャプチャ
================================================

ポートミラーリング
--------------------

* スイッチのコマンドラインインタフェイスを使い、特定のポートの通信をほかのポートにコピー(ミラーリング)するようなコマンドを入力する必要がある
* ネットワークに影響を与えず余分なパケットが生成されない


ハブの使用
------------

* パケットをキャプチャしたい機器と解析用の機器を、ハブに接続することで同じネットワークセグメントに置く


タップの使用
--------------

* ネットワークタップ(タップ)は、2つの通信機器の間に設置して、この2点間のパケットをキャプチャするためのハードウェア
* 統合型タップと非統合型タップの主な違いは、非統合型には4つのポートがあるのに対し、統合型には3つしかないこと

  * 多くの場合、必要なケーブル本数が少なく、機器に2つのNICを必要としない統合型が好まれる
  * 大量の通信をキャプチャする場合や、一方向の通信のみをキャプチャする場合は、非統合型タップがよい 


ARPキャッシュポイズニング
---------------------------

* 送信元の機器はまずARPキャッシュを確認し、宛先の機器のIPアドレスに対応するMACアドレスが格納済みでないかを確認する
* 格納されていなければ、データリンク層のブロードキャストアドレスFF:FF:FF:FF:FF:FFに、ARPリクエストを送る

  * パケットは「MACアドレスXX:XX:XX:XX:XX:XXを所有するIPアドレスは?」と質問している

* このIPアドレスを所有しない機器はARPリクエストを破棄する。宛先になる機器は、ARPレスポンスによってMACアドレスを返答する
* ARPキャッシュポイズニングは、ARPスプーフィングとも呼ばれ、偽りのMAC(第2層)アドレスを含むARPメッセージをイーサネットのスイッチまたはルータに送信し、別の機器のトラフィックに割り込む処理
* ARPキャッシュポイズニングを使用するには、Cain & Abelを使う 

