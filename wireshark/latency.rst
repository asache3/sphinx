=========
Latency
=========

エラーリカバリ機能
====================

* 遅延(レイテンシ)とはパケットが送信されてから受信されるまでの時間のこと

  * 通信機器間での通信速度が速く、パケットがある地点から別の地点までの時間が短ければ、低遅延
  * パケットが届くまでに相当な時間がかかる場合、高遅延


TCP再送
---------

* パケット再送が必要かどうかを決める機構は、再送タイマー
* タイマーはRTO(再送タイムアウト)と呼ばれる値に従って動作する
* TCPを使ってパケットを送信されると再送タイマーがスタートし、そのパケットのACKが受信されるとストップする
* パケットが送信されてからACKパケットが受信されるまでの時間をRTT(ラウンドトリップタイム)と呼び、この時間の平均値が、最終的なRTO値の算出に用いられる


重複ACKと高速転送
-------------------

* イニシャルシーケンス番号(ISN)

  * ISNがコネクションの両側で設定されると、パケットが送信されるごとに、そのパケットのデータのサイズ分だけシーケンス番号が増えていく
  * シーケンス番号 + 受信されたデータのバイト容量 = ACK番号

* データを適切に組み立てるには、消失したパケットを受信する必要があるので、消失したパケットのシーケンス番号を含むACKパケットを再送し、送信元に再送を促す

  * 送信者は3回重複ACKを受け取ると、パケットが本当に消失したと判断し、即座に高速再送を行う

* セレクティブACKが有効になっていると、消失したパケット以外のパケットの受信が成功していれば、消失したパケットのみが再送される


フロー制御
============

* TCPはパケット消失が起こりそうになると、データ転送レートを調整してこれを防ぐスライディングウィンドウという機構を実装している

  * スライディングウィンドウは、受信者の受信ウィンドウを使ってデータフローを制御する
  * 受信ウィンドウは受信者が指定する値で、TCPヘッダに格納されており、TCPのバッファ領域に格納するデータ量を送信者に伝える

* サーバがこれ以上クライアントからのデータを処理できない場合、サーバは受信ウィンドウサイズがゼロであるという通知を含むゼロウィンドウパケットを送信する

  * クライアントがこのパケットを受信すると、データ転送を停止するが、キープアライブパケットを送り、サーバとのコネクションは維持する


遅延を見つけるフレームワーク
==============================

.. csv-table::

  SYN,→,
  SYN/ACK,←,回線遅延
  ACK,→,
  第7層プロトコルのリクエスト,→,クライアント遅延
  ACK,←,回線遅延
  第7層プロトコルのデータ,←,サーバ遅延


ネットワークベースライン
==========================

* ネットワークベースラインは、ネットワーク上のさまざまな位置で収集されたトラフィックのサンプルであり、「正常な」ネットワークトラフィックとみなされるもの
* ベースラインを作成する場合、最低3回ずつは作成する。トラフィックの少ない時間帯(早朝)、トラフィックの多い時間帯(午後)、トラフィックがほとんどない時間帯(深夜)といった具合。
  
